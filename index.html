<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>reveal.js</title>

	<link rel="stylesheet" href="reveal.js/dist/reset.css">
	<link rel="stylesheet" href="reveal.js/dist/reveal.css">
	<link rel="stylesheet" href="reveal.js/dist/theme/black.css">

	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="reveal.js/plugin/highlight/monokai.css">
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<section>
					Nix Concepts:
				</section>
				<section>
					<h3>Lazy</h3>
					Expressions are only evaluated when their value is needed
					(used).
					<pre>
						<code data-trim data-noescape>
							let
							  a = abort "will never happen";
							  b = "hello";
							  c = "world";
							in b + c
						</code>
					</pre>
				</section>
				<section>
					<h3>Functional</h3>
					<div class="r-stack">
						<div class="fragment fade-in-then-out">
							Programming style based on mathematical functions. <br>
							Instead of writing a sequence of operations that should be
							executed. <br>
							You apply functions to input to generate ouput.
						</div>
						<pre class="fragment fade-in-then-out">
							<code data-trim data-noescape>
								names = ['Mary', 'Isla', 'Sam']

								# Procedural
								for i in range(len(names)):
								   names[i] = hash(names[i])

								# Functional
								names = map(hash, names)
							</code>
						</pre>
						<pre class="fragment fade-in-then-out">
							<code data-trim data-noescape>
								let
								  names = [ "Mary" "Isla" "Sam" ];
								in builtins.map (x: builtins.hashString "sha256" x)	names
							</code>
						</pre>
						<pre class="fragment fade-in-then-out">
							<code data-trim data-noescape>
								let
								  names = [ "Mary" "Isla" "Sam" ];
								in builtins.map (builtins.hashString "sha256") names
								# With currying
							</code>
						</pre>
					</div>
				</section>
				<section>
					<h3>Pure</h3>
					A pure function is a function where the return value is only determined by its
					inputs. <br>
					In Nix, all build operations try to be as pure as possible to achieve
					reproducible builds. <br>
					<a href="https://r13y.com/" target="_blank"> Nix reproducibility statistics.</a>
				</section>
			</section>
			<section>
				<section>
					Nix Language
				</section>
				<section data-background-iframe="https://nixos.org/manual/nix/unstable/language/index.html"
					data-background-interactive>
				</section>
			</section>
			<section>
				<section>
					Nix Flakes
				</section>
				<section>
					<div>
						<b>Flakes</b> introduce a dependecy managing system that improves
						<b>reproducibility</b>
						and usability in the nix ecosystem.
					</div>
					<small class="fragment fade-in">Although it's still an experimental feature,
						flakes are widely used in
						the Nix
						community.
					</small>
				</section>
				<section>
					<h4>Top level attributes:</h4>
					<div class="fragment"><b>description</b> is a string describing the flake.</div>
					<div class="fragment"><b>inputs</b> is an attribute set of all the dependencies
						of the flake.</div>
					<div class="fragment"><b>outputs</b> is a function that takes an attribute set
						of all inputs, and outputs another attribute set.</div>
					<div class="fragment"><b>nixConfig</b>
						attribute set which reflect the values given to nix.conf.</div>
				</section>
				<section>
					<h4>Inputs</h4>
					<div class="r-stack">
						<div class="fragment fade-out">
								All the inputs get automatically fetched and evaluated as a flakes.
								<small> 
										If you want non flake project as an input you can specify `flake = false;`
								</small>
						</div>
						<pre class="fragment fade-in-then-out">
							<code data-trim>
								inputs.import-cargo = {
								  type = "github";
								  owner = "edolstra";
								  repo = "import-cargo";
								};
								# or
								inputs.import-cargo.url = "github:edolstra/import-cargo";
							</code>
						</pre>
						<div class="fragment fade-in">
							<h4>Where is the reproducibility tho?</h4>
							<div class="fragment fade-in">
								The lock file!
							</div>
						</div>
					</div>
				</section>
				<section>
					<h4>Lock file</h4>
					<div class="r-stack">
						<div class="fragment fade-out">
							flake.nix are typically "unlocked" (they do NOT specify version/commit), that's why we need the
							flake.lock file that is generated by nix.
						</div>
						<span class="fragment fade-in-then-out">
							The generated lock file contains a graph structure specifying the
							exact <b>version (commit)</b> and <b>hash</b> of the input.
							To ensure reproducibility.
						</span>
					</div>
				</section>
				<section>
					<pre>
						<code data-trim class="r-stretch">
                          "version": 7,
                          "root": "n1",
                          "nodes": {
                            "n1": {
                              "inputs": {
                                "nixpkgs": "n2",
                                "import-cargo": "n3",
                                "grcov": "n4"
                              }
                            },
                            "n2": {
                              "inputs": {},
                              "locked": {
                                "owner": "edolstra",
                                "repo": "nixpkgs",
                                "rev": "7f8d4b088e2df7fdb6b513bc2d6941f1d422a013",
                                "type": "github",
                                "lastModified": 1580555482,
                                "narHash": "sha256-OnpEWzNxF/AU4KlqBXM2s5PWvfI5/BS6xQrPvkF5tO8="
                              },
                              "original": {
                                "id": "nixpkgs",
                                "type": "indirect"
                              }
                            },
                            "n3": {
                              "inputs": {},
                              "locked": {
                                "owner": "edolstra",
                                "repo": "import-cargo",
                                "rev": "8abf7b3a8cbe1c8a885391f826357a74d382a422",
                                "type": "github",
                                "lastModified": 1567183309,
                                "narHash": "sha256-wIXWOpX9rRjK5NDsL6WzuuBJl2R0kUCnlpZUrASykSc="
                              },
                              "original": {
                                "owner": "edolstra",
                                "repo": "import-cargo",
                                "type": "github"
                              }
                            },
                            "n4": {
                              "inputs": {},
                              "locked": {
                                "owner": "mozilla",
                                "repo": "grcov",
                                "rev": "989a84bb29e95e392589c4e73c29189fd69a1d4e",
                                "type": "github",
                                "lastModified": 1580729070,
                                "narHash": "sha256-235uMxYlHxJ5y92EXZWAYEsEb6mm+b069GAd+BOIOxI="
                              },
                              "original": {
                                "owner": "mozilla",
                                "repo": "grcov",
                                "type": "github"
                              },
                              "flake": false
                            }
                          }
                        }
						</code>
					</pre>
				</section>
				<section>
					Flake resolution
				</section>
				<section>
					Flake URL-syntax

					<pre>
						<code data-trim class="r-stretch">
							nix run github:hyprwm/Hyprland
							nix run sourcehut:~michal_atlas/nur-packages#mystic
							nix flake show github:dev-null-undefined/ascii-art

							# Generic version
							nix flake show git+https://github.com/hyprwm/Hyprland
						</code>
					</pre>
				</section>
				<section data-background-iframe="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-flake.html#examples"
					data-background-interactive>
				</section>
				<section>
					<pre>
						<code data-trim class="r-stretch">
							# Without type
							$ nix run foobar#example
							error: cannot find flake 'flake:foobar' in the flake registries

							# Same thing:
							nix flake show flake:gemini
							nix flake show gemini
						</code>
					</pre>
				</section>
				<section>
					<pre>
						<code data-trim class="r-stretch">
                            {
                              "flakes": [
                                {
                                  "from": {
                                    "id": "agda",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "agda",
                                    "repo": "agda",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "arion",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "hercules-ci",
                                    "repo": "arion",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "blender-bin",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "dir": "blender",
                                    "owner": "edolstra",
                                    "repo": "nix-warez",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "cachix",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "cachix",
                                    "repo": "cachix",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "composable",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "ComposableFi",
                                    "repo": "composable",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "disko",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "nix-community",
                                    "repo": "disko",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "dreampkgs",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "nix-community",
                                    "repo": "dreampkgs",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "dwarffs",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "edolstra",
                                    "repo": "dwarffs",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "emacs-overlay",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "nix-community",
                                    "repo": "emacs-overlay",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "fenix",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "nix-community",
                                    "repo": "fenix",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "flake-parts",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "hercules-ci",
                                    "repo": "flake-parts",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "flake-utils",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "numtide",
                                    "repo": "flake-utils",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "gemini",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "nix-community",
                                    "repo": "flake-gemini",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "hercules-ci-effects",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "hercules-ci",
                                    "repo": "hercules-ci-effects",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "hercules-ci-agent",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "hercules-ci",
                                    "repo": "hercules-ci-agent",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "home-manager",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "nix-community",
                                    "repo": "home-manager",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "hydra",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "NixOS",
                                    "repo": "hydra",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "mach-nix",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "DavHau",
                                    "repo": "mach-nix",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "nimble",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "nix-community",
                                    "repo": "flake-nimble",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "nix",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "NixOS",
                                    "repo": "nix",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "nix-darwin",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "LnL7",
                                    "repo": "nix-darwin",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "nixops",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "NixOS",
                                    "repo": "nixops",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "nixos-hardware",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "NixOS",
                                    "repo": "nixos-hardware",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "nixos-homepage",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "NixOS",
                                    "repo": "nixos-homepage",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "nixos-search",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "NixOS",
                                    "repo": "nixos-search",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "nur",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "nix-community",
                                    "repo": "NUR",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "nixpkgs",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "NixOS",
                                    "ref": "nixpkgs-unstable",
                                    "repo": "nixpkgs",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "templates",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "NixOS",
                                    "repo": "templates",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "patchelf",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "NixOS",
                                    "repo": "patchelf",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "poetry2nix",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "nix-community",
                                    "repo": "poetry2nix",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "nix-serve",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "edolstra",
                                    "repo": "nix-serve",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "nickel",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "tweag",
                                    "repo": "nickel",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "bundlers",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "NixOS",
                                    "repo": "bundlers",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "pridefetch",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "SpyHoodle",
                                    "repo": "pridefetch",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "systems",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "nix-systems",
                                    "repo": "default",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "helix",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "helix-editor",
                                    "repo": "helix",
                                    "type": "github"
                                  }
                                },
                                {
                                  "from": {
                                    "id": "sops-nix",
                                    "type": "indirect"
                                  },
                                  "to": {
                                    "owner": "Mic92",
                                    "repo": "sops-nix",
                                    "type": "github"
                                  }
                                }
                              ],
                              "version": 2
                            }
						</code>
					</pre>
				</section>
				<section>
					Flake Outputs
				</section>
				<section data-background-iframe="https://nixos.wiki/wiki/Flakes#Output_schema"
					data-background-interactive>
				</section>
			</section>
			<section>
				Development environments: Demo
			</section>
			<section>
				Declaring your own package: Demo
			</section>
			<section>
				How Nix works?
				<section>
					FHS: Peeking behind the curtain
				</section>
				<section data-background-image="https://linuxconfig.org/wp-content/uploads/2013/03/Directory-Filesystem-Hierarchy-Standard.jpg"
					data-background-size="contain">
				</section>
				<section>
					<div class="r-stack">
						<div>
							<pre>
								<code data-trim class="fragment fade-in">
									# ls /bin
									sh
								</code>
							</pre>
							<pre>
								<code data-trim class="fragment fade-in">
									# ls /lib
									ls: cannot access '/lib': No such file or
									directory
								</code>
							</pre>
							<pre>
								<code data-trim class="fragment fade-in">
									# ls /usr/bin
									env
								</code>
							</pre>
							<small class="fragment fade-in-then-out">
								Huh??<br><img
									data-src="https://media.tenor.com/eRdMTSpHFfIAAAAd/huh-rabbit.gif"
									width="200"></small>
						</div>
						<div class="fragment fade-in">
							<pre>
								<code data-trim class="r-stretch">
									# ls /nix/store

									zzfarkcyb4v11ai1kbk3mdh2y7jalbiq-CVE-2017-8372-CVE-2017-8373.patch.drv
									zzfkkrvn1f4ks46z22rxbhnxg8mmj4bp-python3.10-sphinxcontrib-jsmath-1.0.1.drv
									zzflbnwmr19w0b5vsvf90292bszkbqx4-patchelf-0.15.0.drv
									zzi69bi53biq6zckij6cfwcjggqskbb2-asdf-3.3.6.tar.gz.drv
									zznxvgy5pi4ny9dpl5gkxk9y5i1k436h-wayland-1.22.0.drv
									zzpm91md3wqllaqpzm7whvcpafblcp3d-0007-qtbase-find-tools-in-PATH.patch
									zzrgf0qw8vd3rd3fznzif1fh5k856rdy-libass-0.17.1/
									zzwsixlsccw8vdy6wb9qqzj1fmyjis3n-net-tools-2.10/
									zzxszlz0zj3054j087h0a87vg9chr6vl-foldl-1.4.14-r2.cabal.drv
									zzyy4xm6m2vdqi0h0c0dgr75jl8s0n3b-source.drv
									....
								</code>
							</pre>
						</div>
					</div>
				</section>
				<section>
					RPath
					<pre>
						<code data-trim class="r-stretch">
							$ patchelf --print-rpath
							/nix/store/ffll6glz3gwx342z0ch8wx30p5cnqz1z-python3-3.11.5/bin/python

							/nix/store/ffll6glz3gwx342z0ch8wx30p5cnqz1z-python3-3.11.5/lib:/nix/store/gqghjch4p1s69sv4mcjksb2kb65rwqjy-glibc-2.38-23/lib:/nix/store/9fy9zzhf613xp0c3jsjxbjq6yp8afrsv-gcc-12.3.0-lib/lib
						</code>
					</pre>
				</section>
				<section>
					Dependencies

					<table>
						<tr>
							<th>Compile-time</th>
							<td>Explicitly listed</td>
						</tr>
						<tr>
							<th>Runtime</th>
							<td>Hashes of other paths that exist in a path</td>
						</tr>
					</table>
				</section>
				<section>
				  Derivation: Sandboxed Builds
                                </section>
                                <section>The build sees:
                                  <ul>
                                    <li>Paths referenced by its derivation</li>
                                    <li>That's it...</li>
                                  </ul>
                                </section>
                                <section>
                                  What's a derivation?
                                  <pre>
				    <code data-trim data-noescape>
                                        builtins.derivation {
                                          name = "mybuild";
                                          builder = "${pkgs.python}/bin/python";
                                          args = [ "${./script.py}" ];
                                          system = "x86_64-linux";

                                          # Optional additional environment
                                          PATH="...";
                                          ENV="...";
                                        }
				    </code>
				  </pre>
                                </section>
                                <section>
                                  How does source code get on the machine though?
                                </section>
                                <section>
                                  Fixed-output Derivation:
                                  <pre>
				    <code data-trim data-noescape>
                                        builtins.derivation {
                                          name = "mybuild";
                                          builder = "${pkgs.python}/bin/python";
                                          args = [ "${./script.py}" ];
                                          system = "x86_64-linux";
				    </code>
				  </pre>
                                  <pre>
				    <code data-trim data-noescape class="fragment fade-in">
                                          outputHashAlgo = "sha256";
                                          outputHash = "...";
                                        }
				    </code>
				  </pre>
                                </section>
                                <section>The build sees:
                                  <ul>
                                    <li>Paths referenced by its derivation</li>
                                    <li>That's it...</li>
                                    <li class="fragment fade-in">The Internet</li>
                                  </ul>
                                </section>
			        <section data-background-iframe="https://ryantm.github.io/nixpkgs/builders/fetchers/"
					 data-background-interactive>
                                  In practice:
                                </section>
			</section>
		</div>
	</div>

	<script src="reveal.js/dist/reveal.js"></script>
	<script src="reveal.js/plugin/notes/notes.js"></script>
	<script src="reveal.js/plugin/markdown/markdown.js"></script>
	<script src="reveal.js/plugin/highlight/highlight.js"></script>
	<script src="reveal.js/plugin/search/search.js"></script>
	<script src="reveal.js/plugin/math/math.js"></script>
	<script src="reveal.js/plugin/notes/notes.js"></script>
	<script src="reveal.js/plugin/zoom/zoom.js"></script>
	<script>
		// More info about initialization & config:
		// - https://revealjs.com/initialization/
		// - https://revealjs.com/config/
		Reveal.initialize({
			hash: true,

			slideNumber: "c/t",

			preloadIframes: true,

			// Learn about plugins: https://revealjs.com/plugins/
			plugins: [RevealMarkdown, RevealHighlight, RevealSearch, RevealMath, RevealNotes, RevealZoom]
		});
	</script>
</body>

</html>
